#!/usr/bin/env bash

function main {
  local shome="$(cd -P -- "${BASH_SOURCE%/*}/.." && pwd -P)"

  if [[ -x ".script/deploy" ]]; then
    if [[ -z "${DEPLOY_IN_STUB:-}" ]]; then
      export DEPLOY_IN_STUB=1
      exec ".script/deploy" "$@"
      return 1
    fi
  fi

  case "${!#}" in
    *.yml|*.yaml)
      true
      ;;

    *)
      if [[ -z "${1:-}" && -f .deploy-default ]]; then
        exec deploy "$(cat .deploy-default)" --list-hosts
        return 1
      else
        if [[ -f "playbooks/$(basename $(pwd)).yml" ]]; then
          set -- "$@" playbooks/$(basename $(pwd)).yml
        elif [[ -f "playbooks/deploy.yml" ]]; then
          set -- "$@" playbooks/deploy.yml
        fi
      fi
      ;;
  esac

  block require ansible-playbook ${opt_ansible:+"${opt_ansible[@]}"} "$@"
}

source sub "$0" "$@"
