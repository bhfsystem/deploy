#!/usr/bin/env bash

function main {
  local shome="$(cd -P -- "${BASH_SOURCE%/*}/.." && pwd -P)"

  if [[ -x ".script/deploy" ]]; then
    if [[ -z "${DEPLOY_IN_STUB:-}" ]]; then
      export DEPLOY_IN_STUB=1
      exec ".script/deploy" "$@"
      return 1
    fi
  fi

  if [[ -f .deploy-default ]]; then
    exec deploy "$(cat .deploy-default)" "$@"
    return 1
  fi

  local fl_playbook=
  for a in "$@"; do
    case "$a" in
      *.yml|*.yaml)
        fl_playbook=1
        ;;
    esac
  done

  if [[ -z "$fl_playbook" ]]; then
    if [[ -f "playbooks/$(basename $(pwd)).yml" ]]; then
      set -- "$@" playbooks/$(basename $(pwd)).yml
    elif [[ -f "playbooks/deploy.yml" ]]; then
      set -- "$@" playbooks/deploy.yml
    fi
  fi

  block require ansible-playbook ${opt_ansible:+"${opt_ansible[@]}"} "$@"
}

source sub "$0" "$@"
